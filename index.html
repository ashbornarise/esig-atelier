<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESIG Atelier - Tableau de bord</title>
    <link rel="icon" type="image/png" href="logo-esig.png">
    <!-- Font Awesome 6 - Sans int√©grit√© pour √©viter les blocages CORS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(to bottom, #ffffff 0%, #2563eb 100%);
            /* Vertical White to Vivid Blue */
            background-attachment: fixed;
            min-height: 100vh;
        }

        /* Auth Loader */
        #auth-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100px); opacity: 0; }
        }

        .app {
            display: none;
            /* Hidden by default until auth check */
            flex-direction: column;
            min-height: 100vh;
        }

        /* HEADER */
        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-actions {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-icon {
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.05);
        }

        /* MAIN CONTENT */
        .main {
            flex: 1;
            padding: 24px;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #3b82f6;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.2);
        }

        .stat-label {
            color: #374151;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-label i {
            color: #3b82f6;
            font-size: 20px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: #1e40af;
        }

        /* FORM SECTIONS */
        .section {
            background: white;
            padding: 28px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
            margin-bottom: 24px;
            display: none;
        }

        .section.active {
            display: block;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title i {
            font-size: 24px;
            color: #3b82f6;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #3b82f6;
            background: #eff6ff;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
        }

        /* SEARCH & FILTER */
        .filter-bar {
            margin-bottom: 16px;
            display: flex;
            gap: 12px;
        }

        .filter-bar input,
        .filter-bar select {
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }

        /* BOTTOM NAVIGATION */
        .bottom-nav {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 12px 16px;
            background: white;
            border-top: 2px solid #e5e7eb;
            box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
            width: 100%;
            position: sticky;
            bottom: 0;
        }

        .nav-item {
            background: none;
            border: 2px solid transparent;
            padding: 10px 8px;
            cursor: pointer;
            text-align: center;
            color: #6b7280;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .nav-item i {
            font-size: 22px;
        }

        .nav-item.active {
            color: #1e40af;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-color: #3b82f6;
        }

        .nav-item:hover:not(.active) {
            color: #3b82f6;
            background: #f8fafc;
            border-color: #e5e7eb;
        }

        /* ALERT */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
            border-left: 4px solid;
        }

        .alert.show {
            display: block;
        }

        .alert.success {
            background: #ecfdf5;
            color: #065f46;
            border-left-color: #10b981;
        }

        .alert.error {
            background: #fef2f2;
            color: #7f1d1d;
            border-left-color: #ef4444;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            margin: 40px auto;
            padding: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            color: #1e40af;
            font-size: 18px;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
        }

        /* RESPONSIVE - TABLETTE */
        @media (max-width: 1024px) {
            .main {
                padding: 20px;
                max-width: 100%;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }

            .stat-card {
                padding: 20px;
            }

            .stat-value {
                font-size: 28px;
            }

            .header {
                padding: 14px 20px;
            }

            .header-title {
                font-size: 20px;
            }

            .modal-content {
                max-width: 90%;
                margin: 20px auto;
            }
        }

        /* RESPONSIVE - MOBILE */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-value {
                font-size: 24px;
            }

            .stat-label {
                font-size: 12px;
            }

            .stat-label i {
                font-size: 16px;
            }

            .filter-bar {
                flex-direction: column;
                gap: 10px;
            }

            .filter-bar input,
            .filter-bar select {
                width: 100%;
            }

            .header {
                padding: 12px 16px;
                flex-wrap: wrap;
                gap: 10px;
            }

            .header-title {
                font-size: 16px;
            }

            .header-title img {
                width: 28px !important;
                height: 28px !important;
            }

            .header-actions {
                gap: 8px;
            }

            .btn-icon {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }

            /* Am√©lioration cartes TP mobile */
            #tpContent > div,
            #mesTP > div {
                padding: 14px !important;
                margin-bottom: 12px !important;
            }

            #tpContent h4,
            #mesTP h4 {
                font-size: 15px !important;
            }

            #tpContent p,
            #mesTP p {
                font-size: 12px !important;
            }

            /* Boutons TP responsive */
            #mesTP button {
                padding: 8px 12px !important;
                font-size: 12px !important;
            }

            /* Section s√©curit√© responsive */
            #securiteSection > div {
                padding: 12px !important;
                margin-bottom: 12px !important;
            }

            /* Grilles proc√©dures urgence */
            #proceduresUrgence > div {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            .user-profile {
                display: none;
            }

            .main {
                padding: 12px;
            }

            .section {
                padding: 16px;
                border-radius: 10px;
            }

            .section-title {
                font-size: 16px;
                flex-wrap: wrap;
                gap: 8px;
            }

            .section-title i {
                font-size: 20px;
            }

            label {
                font-size: 13px;
            }

            input, select, textarea {
                padding: 10px 12px;
                font-size: 14px;
            }

            .btn-primary {
                padding: 10px 18px;
                font-size: 14px;
            }

            .bottom-nav {
                padding: 10px 8px;
                gap: 4px;
            }

            .nav-item {
                padding: 8px 4px;
                font-size: 10px;
            }

            .nav-item i {
                font-size: 18px;
            }

            .modal-content {
                width: 95%;
                margin: 20px auto;
                padding: 16px;
                border-radius: 10px;
            }

            .modal-title {
                font-size: 16px;
            }
        }

        /* RESPONSIVE - PETIT MOBILE */
        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-value {
                font-size: 22px;
            }

            .stat-label {
                font-size: 11px;
                gap: 4px;
            }

            .stat-label i {
                font-size: 14px;
            }

            /* Modal plein √©cran sur mobile */
            .modal-content {
                width: 100% !important;
                height: 100% !important;
                max-height: 100% !important;
                margin: 0 !important;
                border-radius: 0 !important;
                padding: 15px !important;
                overflow-y: auto !important;
            }

            /* Modal membres responsive */
            #membresModal .modal-content {
                max-width: 100% !important;
            }

            #membresModal input {
                font-size: 16px;
            }

            #currentMembers > div,
            #searchResults > div {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 10px !important;
            }

            #currentMembers button,
            #searchResults button {
                width: 100% !important;
            }

            /* Cartes TP mobile optimis√©es */
            #mesTP > div > div:first-child {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 10px !important;
            }

            #mesTP > div > div:last-child {
                flex-direction: column !important;
                width: 100% !important;
            }

            #mesTP > div > div:last-child button {
                width: 100% !important;
                justify-content: center !important;
            }

            /* Section s√©curit√© mobile */
            #securiteSection h3 {
                font-size: 14px !important;
            }

            #consignesGenerales > div,
            #zonesSecurite > div,
            #consignesMachines > div {
                padding: 10px !important;
            }

            /* Proc√©dures urgence 2 colonnes */
            #proceduresUrgence > div {
                grid-template-columns: 1fr 1fr !important;
                gap: 8px !important;
            }

            #proceduresUrgence > div > div {
                padding: 10px !important;
            }

            #proceduresUrgence i {
                font-size: 20px !important;
            }

            .header {
                padding: 10px 12px;
            }

            .header-title {
                font-size: 14px;
                gap: 8px;
            }

            .header-title img {
                width: 24px !important;
                height: 24px !important;
            }

            .btn-icon {
                width: 32px;
                height: 32px;
                font-size: 14px;
                border-radius: 6px;
            }

            .main {
                padding: 10px;
            }

            .section {
                padding: 14px;
                margin-bottom: 16px;
            }

            .section-title {
                font-size: 15px;
                margin-bottom: 16px;
            }

            .form-group {
                margin-bottom: 14px;
            }

            input, select, textarea {
                padding: 10px;
                font-size: 14px;
                border-radius: 6px;
            }

            textarea {
                min-height: 100px;
            }

            .btn-primary {
                padding: 12px 16px;
                font-size: 14px;
                border-radius: 6px;
                width: 100%;
            }

            .bottom-nav {
                padding: 8px 6px;
                gap: 2px;
            }

            .nav-item {
                padding: 6px 2px;
                font-size: 9px;
                border-radius: 8px;
            }

            .nav-item i {
                font-size: 16px;
            }

            /* Settings Modal responsive */
            #settingsModal .modal-content {
                max-width: 100%;
                width: 95%;
                padding: 16px;
            }

            #settingsModal #profileAvatar {
                width: 80px !important;
                height: 80px !important;
                font-size: 28px !important;
            }

            #settingsModal #profileFullName {
                font-size: 18px;
            }

            #settingsTabProfile > div:nth-child(2) {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 8px !important;
            }

            #settingsTabProfile > div:nth-child(2) > div {
                padding: 10px 6px !important;
            }

            #settingsTabProfile > div:nth-child(2) > div > div:first-child {
                font-size: 20px !important;
            }

            #settingsTabProfile > div:nth-child(2) > div > div:last-child {
                font-size: 10px !important;
            }

            #profileEditForm {
                padding: 12px !important;
            }

            #profileEditForm > div {
                grid-template-columns: 1fr !important;
            }
        }

        /* RESPONSIVE - TR√àS PETIT √âCRAN */
        @media (max-width: 360px) {
            .header-title {
                font-size: 12px;
            }

            .header-title img {
                width: 20px !important;
                height: 20px !important;
            }

            .btn-icon {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }

            .stats-grid {
                gap: 8px;
            }

            .stat-card {
                padding: 10px;
            }

            .stat-value {
                font-size: 20px;
            }

            .stat-label {
                font-size: 10px;
            }

            .nav-item {
                font-size: 8px;
            }

            .nav-item i {
                font-size: 14px;
            }
        }

        /* Mode paysage pour mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .main {
                padding: 10px;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .stat-card {
                padding: 12px;
            }

            .stat-value {
                font-size: 20px;
            }

            .bottom-nav {
                padding: 6px 10px;
            }

            .nav-item {
                padding: 6px 8px;
            }

            .nav-item i {
                font-size: 16px;
            }
        }
    </style>
</head>

<body>
    <div id="auth-loader">
        <div class="spinner"></div>
    </div>
    <div class="app" id="app-content">
        <!-- HEADER -->
        <div class="header">
            <div class="header-title">
                <img src="logo-esig.png" style="width: 32px; height: 32px; margin-right: 12px;">
                ESIG Atelier
            </div>
            <div class="header-actions">
                <div class="user-profile">
                    <i class="fas fa-user-circle"></i>
                    <span id="userName">Utilisateur</span>
                </div>
                <button class="btn-icon" onclick="openSettingsModal()" title="Param√®tres">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="btn-icon" onclick="adminPanel()" id="adminBtn" style="display:none;" title="Admin">
                    <i class="fas fa-user-shield"></i>
                </button>
                <button class="btn-icon" onclick="logout()" title="D√©connexion">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main">
            <!-- STATS -->
            <div class="stats-grid" id="statsSection">
                <div class="stat-card">
                    <div class="stat-label"><i class="fas fa-book"></i> Mes TP</div>
                    <div class="stat-value" id="statTP">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label"><i class="fas fa-wrench"></i> Machines</div>
                    <div class="stat-value" id="statMachines">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label"><i class="fas fa-box"></i> Stock</div>
                    <div class="stat-value" id="statStock">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label"><i class="fas fa-tools"></i> Maintenance</div>
                    <div class="stat-value" id="statMaintenance">0</div>
                </div>
            </div>

            <!-- TP SECTION -->
            <div id="tpSection" class="section active">
                <!-- MES TP - Liste -->
                <div class="section-title" style="margin-bottom: 16px;">
                    <i class="fas fa-book"></i> Mes Travaux Pratiques
                    <span id="myTPCount" style="margin-left: auto; background: #3b82f6; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">0</span>
                </div>

                <div id="myTPList" style="margin-bottom: 24px;">
                    <p style="text-align: center; color: #9ca3af; padding: 20px;">Chargement de vos TP...</p>
                </div>

                <!-- Formulaire cr√©ation -->
                <div style="border-top: 2px solid #e5e7eb; padding-top: 24px; margin-top: 16px;">
                    <div class="section-title">
                        <i class="fas fa-plus-circle"></i> Cr√©er un nouveau TP
                    </div>
                    <div id="tpAlert" class="alert"></div>
                    <form id="tpForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Titre du TP</label>
                                <input type="text" id="tpTitre" placeholder="Ex: TP Circuits √©lectriques" required>
                            </div>
                            <div class="form-group">
                                <label>Type</label>
                                <select id="tpType" required>
                                    <option value="">S√©lectionner...</option>
                                    <option value="usinage">Usinage</option>
                                    <option value="tournage">Tournage</option>
                                    <option value="fraisage">Fraisage</option>
                                    <option value="soudure">Soudure</option>
                                    <option value="electronique">√âlectronique</option>
                                    <option value="maintenance">Maintenance</option>
                                    <option value="autre">Autre</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Date de d√©but</label>
                                <input type="date" id="tpDateDebut" required>
                            </div>
                            <div class="form-group">
                                <label>Heure de d√©but</label>
                                <input type="time" id="tpHeureDebut" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Dur√©e (heures)</label>
                                <input type="number" id="tpDuree" min="0.5" step="0.5" placeholder="Ex: 2.5" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="tpDescription" placeholder="D√©crivez les objectifs et d√©roulement..."></textarea>
                        </div>

                        <button type="submit" class="btn-primary">
                            <i class="fas fa-plus"></i> Cr√©er le TP
                        </button>
                    </form>
                </div>
            </div>

            <!-- MACHINES SECTION -->
            <div id="machinesSection" class="section">
                <div class="section-title">
                    <i class="fas fa-wrench"></i> Machines
                    <span style="margin-left: auto; font-size: 13px; color: #6b7280; font-weight: 400;">Total: <span
                            id="machinesCount">0</span></span>
                </div>
                <div class="filter-bar">
                    <input type="text" id="machinesSearch" placeholder="üîç Rechercher..." style="flex: 1;">
                    <select id="machinesFilter" style="width: auto;">
                        <option value="">Tous</option>
                        <option value="disponible">Disponible</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="panne">Panne</option>
                    </select>
                </div>
                <div id="machinesContent"></div>
            </div>

            <!-- STOCK SECTION -->
            <div id="stockSection" class="section">
                <div class="section-title">
                    <i class="fas fa-box"></i> Inventaire
                    <span style="margin-left: auto; font-size: 13px; color: #6b7280; font-weight: 400;">Total: <span
                            id="stockCount">0</span></span>
                </div>
                <div class="filter-bar">
                    <input type="text" id="stockSearch" placeholder="üîç Rechercher..." style="flex: 1;">
                    <select id="stockFilter" style="width: auto;">
                        <option value="">Tous</option>
                        <option value="critique">Critique</option>
                        <option value="faible">Faible</option>
                        <option value="normal">Normal</option>
                    </select>
                </div>
                <div id="stockContent"></div>
            </div>

            <!-- MAINTENANCE SECTION -->
            <div id="maintenanceSection" class="section">
                <div class="section-title">
                    <i class="fas fa-tools"></i> Maintenance
                    <span style="margin-left: auto; font-size: 13px; color: #6b7280; font-weight: 400;">Total: <span
                            id="maintenanceCount">0</span></span>
                </div>
                <div class="filter-bar">
                    <input type="text" id="maintenanceSearch" placeholder="üîç Rechercher..." style="flex: 1;">
                    <select id="maintenanceFilter" style="width: auto;">
                        <option value="">Tous</option>
                        <option value="urgent">Urgent</option>
                        <option value="en cours">En cours</option>
                        <option value="planifi√©e">Planifi√©e</option>
                    </select>
                </div>
                <div id="maintenanceContent"></div>
            </div>

            <!-- S√âCURIT√â SECTION -->
            <div id="securiteSection" class="section" style="display: none;">
                <div class="section-title">
                    <i class="fas fa-shield-alt"></i> S√©curit√©
                </div>

                <!-- Alertes actives pour l'utilisateur -->
                <div id="userAlertesSecurite" style="margin-bottom: 20px;"></div>

                <!-- Consignes g√©n√©rales -->
                <div style="background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid #e5e7eb;">
                    <h3 style="color: #1e40af; margin: 0 0 16px 0; font-size: 16px;">
                        <i class="fas fa-clipboard-list"></i> Consignes de S√©curit√© G√©n√©rales
                    </h3>
                    <div id="consignesGenerales">
                        <p style="color: #9ca3af; text-align: center; padding: 20px;">Chargement des consignes...</p>
                    </div>
                </div>

                <!-- Consignes par zone -->
                <div style="background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid #e5e7eb;">
                    <h3 style="color: #1e40af; margin: 0 0 16px 0; font-size: 16px;">
                        <i class="fas fa-map-marked-alt"></i> Zones de Travail & EPI Requis
                    </h3>
                    <div id="zonesSecurite">
                        <p style="color: #9ca3af; text-align: center; padding: 20px;">Chargement des zones...</p>
                    </div>
                </div>

                <!-- Consignes par machine -->
                <div style="background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid #e5e7eb;">
                    <h3 style="color: #1e40af; margin: 0 0 16px 0; font-size: 16px;">
                        <i class="fas fa-cog"></i> Consignes par Machine
                    </h3>
                    <div id="consignesMachines">
                        <p style="color: #9ca3af; text-align: center; padding: 20px;">Chargement...</p>
                    </div>
                </div>

                <!-- Proc√©dures d'urgence -->
                <div style="background: linear-gradient(135deg, #fef2f2, #fee2e2); border-radius: 12px; padding: 16px; border: 1px solid #fecaca;">
                    <h3 style="color: #991b1b; margin: 0 0 16px 0; font-size: 16px;">
                        <i class="fas fa-first-aid"></i> Proc√©dures d'Urgence
                    </h3>
                    <div id="proceduresUrgence">
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">
                            <div style="background: white; border-radius: 8px; padding: 12px; text-align: center; border: 1px solid #fecaca;">
                                <i class="fas fa-fire-extinguisher" style="font-size: 24px; color: #ef4444; margin-bottom: 8px;"></i>
                                <p style="margin: 0; font-size: 12px; color: #991b1b; font-weight: 600;">Extincteur</p>
                                <p style="margin: 4px 0 0 0; font-size: 11px; color: #6b7280;">Pr√®s de chaque zone</p>
                            </div>
                            <div style="background: white; border-radius: 8px; padding: 12px; text-align: center; border: 1px solid #fecaca;">
                                <i class="fas fa-door-open" style="font-size: 24px; color: #10b981; margin-bottom: 8px;"></i>
                                <p style="margin: 0; font-size: 12px; color: #991b1b; font-weight: 600;">Sortie de secours</p>
                                <p style="margin: 4px 0 0 0; font-size: 11px; color: #6b7280;">Suivre signalisation</p>
                            </div>
                            <div style="background: white; border-radius: 8px; padding: 12px; text-align: center; border: 1px solid #fecaca;">
                                <i class="fas fa-phone-alt" style="font-size: 24px; color: #3b82f6; margin-bottom: 8px;"></i>
                                <p style="margin: 0; font-size: 12px; color: #991b1b; font-weight: 600;">Urgences</p>
                                <p style="margin: 4px 0 0 0; font-size: 11px; color: #6b7280;">112 / 15 / 18</p>
                            </div>
                            <div style="background: white; border-radius: 8px; padding: 12px; text-align: center; border: 1px solid #fecaca;">
                                <i class="fas fa-medkit" style="font-size: 24px; color: #f59e0b; margin-bottom: 8px;"></i>
                                <p style="margin: 0; font-size: 12px; color: #991b1b; font-weight: 600;">Trousse secours</p>
                                <p style="margin: 4px 0 0 0; font-size: 11px; color: #6b7280;">Entr√©e atelier</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL -->
        <div id="modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="modalTitle"></h2>
                    <button class="modal-close" onclick="closeModal()">‚úï</button>
                </div>
                <div id="modalBody"></div>
                <button onclick="closeModal()" class="btn-primary"
                    style="width: 100%; margin-top: 16px;">Fermer</button>
            </div>
        </div>

        <!-- MEMBRES TP MODAL -->
        <div id="membresModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-users"></i> G√©rer les Membres</h2>
                    <button class="modal-close" onclick="closeMembresModal()">‚úï</button>
                </div>
                <p id="membresTPTitle" style="color: #6b7280; margin-bottom: 16px;"></p>

                <!-- Recherche utilisateur -->
                <div style="margin-bottom: 16px;">
                    <label style="font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">Ajouter un membre</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="searchMembre" placeholder="Rechercher par nom ou email..." style="flex: 1; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;">
                        <button onclick="searchUsers()" style="padding: 10px 16px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div id="searchResults" style="margin-top: 10px; max-height: 150px; overflow-y: auto;"></div>
                </div>

                <!-- Liste des membres actuels -->
                <div>
                    <label style="font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">Membres actuels</label>
                    <div id="currentMembers" style="max-height: 200px; overflow-y: auto;">
                        <p style="color: #9ca3af; text-align: center;">Chargement...</p>
                    </div>
                </div>

                <button onclick="closeMembresModal()" class="btn-primary" style="width: 100%; margin-top: 16px;">Fermer</button>
            </div>
        </div>

        <!-- SETTINGS MODAL -->
        <div id="settingsModal" class="modal">
            <div class="modal-content" style="max-width: 550px;">
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-cog"></i> Param√®tres</h2>
                    <button class="modal-close" onclick="closeSettingsModal()">‚úï</button>
                </div>

                <!-- Navigation par onglets -->
                <div style="display: flex; border-bottom: 2px solid #e5e7eb; margin-bottom: 20px;">
                    <button onclick="showSettingsTab('profile')" class="settings-tab active" id="tabProfile" style="flex: 1; padding: 12px; background: none; border: none; cursor: pointer; font-weight: 600; color: #3b82f6; border-bottom: 3px solid #3b82f6;">
                        <i class="fas fa-user"></i> √Ä propos
                    </button>
                    <button onclick="showSettingsTab('settings')" class="settings-tab" id="tabSettings" style="flex: 1; padding: 12px; background: none; border: none; cursor: pointer; font-weight: 500; color: #6b7280; border-bottom: 3px solid transparent;">
                        <i class="fas fa-cog"></i> Param√®tres
                    </button>
                </div>

                <!-- ONGLET √Ä PROPOS DE MOI -->
                <div id="settingsTabProfile" class="settings-tab-content">
                    <!-- Photo de profil et initiales -->
                    <div style="text-align: center; margin-bottom: 24px;">
                        <div id="profileAvatar" style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6, #1e40af); display: flex; align-items: center; justify-content: center; color: white; font-size: 36px; font-weight: bold; margin: 0 auto 12px; box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);">
                            --
                        </div>
                        <h3 id="profileFullName" style="color: #1e40af; margin: 0 0 4px 0;">-</h3>
                        <p id="profileEmail" style="color: #6b7280; margin: 0; font-size: 14px;">-</p>
                    </div>

                    <!-- Statistiques -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
                        <div style="text-align: center; background: #eff6ff; padding: 12px; border-radius: 12px;">
                            <div id="profileStatTP" style="font-size: 24px; font-weight: 700; color: #1e40af;">0</div>
                            <div style="font-size: 11px; color: #6b7280; text-transform: uppercase;">TP cr√©√©s</div>
                        </div>
                        <div style="text-align: center; background: #f0fdf4; padding: 12px; border-radius: 12px;">
                            <div id="profileStatDays" style="font-size: 24px; font-weight: 700; color: #166534;">0</div>
                            <div style="font-size: 11px; color: #6b7280; text-transform: uppercase;">Jours actif</div>
                        </div>
                        <div style="text-align: center; background: #fef3c7; padding: 12px; border-radius: 12px;">
                            <div id="profileStatLevel" style="font-size: 24px; font-weight: 700; color: #92400e;">-</div>
                            <div style="font-size: 11px; color: #6b7280; text-transform: uppercase;">Niveau</div>
                        </div>
                    </div>

                    <!-- Formulaire d'√©dition -->
                    <form id="profileEditForm" style="background: #f8fafc; padding: 16px; border-radius: 12px;">
                        <h4 style="color: #1e40af; margin: 0 0 16px 0; font-size: 14px;">
                            <i class="fas fa-edit"></i> Modifier mes informations
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">Pr√©nom</label>
                                <input type="text" id="editPrenom" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">Nom</label>
                                <input type="text" id="editNom" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                        </div>
                        <div style="margin-top: 12px;">
                            <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">T√©l√©phone</label>
                            <input type="tel" id="editTelephone" placeholder="+228 XX XX XX XX" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                            <div>
                                <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">Niveau</label>
                                <select id="editNiveau" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                    <option value="">S√©lectionner...</option>
                                    <option value="L1">Licence 1</option>
                                    <option value="L2">Licence 2</option>
                                    <option value="L3">Licence 3</option>
                                    <option value="M1">Master 1</option>
                                    <option value="M2">Master 2</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">Groupe</label>
                                <input type="text" id="editGroupe" placeholder="Ex: GI-A" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                        </div>
                        <button type="submit" class="btn-primary" style="width: 100%; margin-top: 16px;">
                            <i class="fas fa-save"></i> Enregistrer les modifications
                        </button>
                    </form>

                    <!-- Date d'inscription -->
                    <p id="profileDateInscription" style="text-align: center; color: #9ca3af; font-size: 12px; margin-top: 16px;">
                        Membre depuis: -
                    </p>
                </div>

                <!-- ONGLET PARAM√àTRES -->
                <div id="settingsTabSettings" class="settings-tab-content" style="display: none;">
                    <!-- LANGUE -->
                    <div class="settings-section" style="margin-bottom: 20px;">
                        <h3 style="color: #1e40af; margin-bottom: 16px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-globe"></i> Langue
                        </h3>
                        <select id="settingsLanguage" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; cursor: pointer;">
                            <option value="fr" selected>Fran√ßais</option>
                            <option value="en">English</option>
                        </select>
                    </div>

                    <!-- MES DOCUMENTS -->
                    <div class="settings-section" style="margin-bottom: 20px;">
                        <h3 style="color: #1e40af; margin-bottom: 16px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-folder-open"></i> Mes Documents
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button onclick="viewMyTP()" type="button" style="width: 100%; padding: 12px; background: #f8fafc; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #374151; font-weight: 500; text-align: left;">
                                <i class="fas fa-book" style="color: #3b82f6; width: 20px;"></i> Voir mes TP
                            </button>
                            <button onclick="exportMyData()" type="button" style="width: 100%; padding: 12px; background: #f8fafc; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #374151; font-weight: 500; text-align: left;">
                                <i class="fas fa-download" style="color: #10b981; width: 20px;"></i> Exporter mes donn√©es
                            </button>
                        </div>
                    </div>

                    <!-- S√âCURIT√â -->
                    <div class="settings-section" style="margin-bottom: 20px;">
                        <h3 style="color: #1e40af; margin-bottom: 16px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-shield-alt"></i> S√©curit√©
                        </h3>
                        <button onclick="resetPassword()" type="button" style="width: 100%; padding: 12px; background: #fef2f2; border: 2px solid #fecaca; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; color: #991b1b; font-weight: 500;">
                            <i class="fas fa-key"></i> Modifier mon mot de passe
                        </button>
                    </div>

                    <!-- THEME -->
                    <div class="settings-section" style="margin-bottom: 20px;">
                        <h3 style="color: #1e40af; margin-bottom: 16px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-palette"></i> Apparence
                        </h3>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="setTheme('light')" type="button" style="flex: 1; padding: 12px; background: #ffffff; border: 2px solid #3b82f6; border-radius: 8px; cursor: pointer; color: #374151; font-weight: 500;">
                                <i class="fas fa-sun"></i> Clair
                            </button>
                            <button onclick="setTheme('dark')" type="button" style="flex: 1; padding: 12px; background: #1e293b; border: 2px solid #1e293b; border-radius: 8px; cursor: pointer; color: white; font-weight: 500;">
                                <i class="fas fa-moon"></i> Sombre
                            </button>
                        </div>
                    </div>

                    <!-- A PROPOS APP -->
                    <div class="settings-section" style="border-top: 1px solid #e5e7eb; padding-top: 16px;">
                        <p style="color: #9ca3af; font-size: 12px; text-align: center;">
                            <strong>ESIG Atelier</strong> v2.0.0<br>
                            ¬© 2026 ESIG Global Success - Lom√©, Togo<br>
                            <a href="#" style="color: #3b82f6; text-decoration: none;">Conditions d'utilisation</a> ‚Ä¢
                            <a href="#" style="color: #3b82f6; text-decoration: none;">Politique de confidentialit√©</a>
                        </p>
                    </div>
                </div>

                <button onclick="closeSettingsModal()" class="btn-primary" style="width: 100%; margin-top: 16px;">
                    <i class="fas fa-times"></i> Fermer
                </button>
            </div>
        </div>

        <!-- BOTTOM NAVIGATION -->
        <div class="bottom-nav">
            <button class="nav-item active" data-nav="tp" onclick="switchSection('tp')">
                <i class="fas fa-book"></i> TP
            </button>
            <button class="nav-item" data-nav="machines" onclick="switchSection('machines')">
                <i class="fas fa-wrench"></i> Machines
            </button>
            <button class="nav-item" data-nav="stock" onclick="switchSection('stock')">
                <i class="fas fa-box"></i> Stock
            </button>
            <button class="nav-item" data-nav="maintenance" onclick="switchSection('maintenance')">
                <i class="fas fa-tools"></i> Maintenance
            </button>
            <button class="nav-item" data-nav="securite" onclick="switchSection('securite')">
                <i class="fas fa-shield-alt"></i> S√©curit√©
            </button>
        </div>
    </div>

    <!-- CHATBOT IA -->
    <button id="chatbotBtn" onclick="toggleChat()" style="
        position: fixed;
        bottom: 90px;
        right: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #1e40af, #3b82f6);
        color: white;
        border: none;
        cursor: pointer;
        box-shadow: 0 6px 20px rgba(30, 64, 175, 0.4);
        z-index: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        transition: all 0.3s ease;
    ">
        <i class="fas fa-robot"></i>
    </button>

    <div id="chatPanel" style="
        position: fixed;
        bottom: 0;
        right: 0;
        width: 400px;
        height: 600px;
        background: white;
        border-radius: 16px 16px 0 0;
        box-shadow: 0 -8px 40px rgba(0,0,0,0.2);
        z-index: 600;
        display: none;
        flex-direction: column;
        overflow: hidden;
    ">
        <!-- Header -->
        <div style="background: linear-gradient(135deg, #1e40af, #3b82f6); color: white; padding: 16px; display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-robot" style="font-size: 20px;"></i>
                </div>
                <div>
                    <h3 style="margin: 0; font-size: 15px;">Elise</h3>
                    <p style="margin: 0; font-size: 11px; opacity: 0.8;">Experte en Ingenierie - ESIG</p>
                </div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button onclick="clearChat()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 8px; cursor: pointer;" title="Effacer">
                    <i class="fas fa-trash"></i>
                </button>
                <button onclick="toggleChat()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Messages -->
        <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; background: #f8fafc;">
        </div>

        <!-- Input -->
        <div style="padding: 12px; border-top: 1px solid #e5e7eb; background: white;">
            <div style="display: flex; gap: 8px;">
                <input type="text" id="chatInput" placeholder="Posez votre question..." style="
                    flex: 1;
                    padding: 12px 16px;
                    border: 2px solid #e5e7eb;
                    border-radius: 24px;
                    font-size: 14px;
                    outline: none;
                    transition: border-color 0.3s;
                " onkeypress="if(event.key==='Enter')sendChatMessage()" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e7eb'">
                <button onclick="sendChatMessage()" style="
                    width: 44px;
                    height: 44px;
                    border-radius: 50%;
                    background: linear-gradient(135deg, #1e40af, #3b82f6);
                    color: white;
                    border: none;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    flex-shrink: 0;
                ">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <style>
        /* CHATBOT RESPONSIVE */
        @media (max-width: 640px) {
            #chatPanel {
                width: 100% !important;
                height: 100% !important;
                border-radius: 0 !important;
            }
            #chatbotBtn {
                bottom: 80px !important;
                right: 16px !important;
                width: 52px !important;
                height: 52px !important;
                font-size: 20px !important;
            }
        }

        @media (min-width: 641px) and (max-width: 768px) {
            #chatPanel {
                width: 360px !important;
                height: 550px !important;
            }
        }

        #chatbotBtn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(30, 64, 175, 0.5);
        }

        #chatPanel.active {
            display: flex !important;
            animation: chatSlideUp 0.3s ease forwards;
        }

        #chatPanel.closing {
            display: flex !important;
            animation: chatSlideDown 0.3s ease forwards;
        }

        @keyframes chatSlideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes chatSlideDown {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(100%); opacity: 0; }
        }

        .chat-msg-bot {
            align-self: flex-start;
            background: white;
            color: #1e293b;
            padding: 12px 16px;
            border-radius: 4px 16px 16px 16px;
            max-width: 85%;
            font-size: 14px;
            line-height: 1.6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .chat-msg-user {
            align-self: flex-end;
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            padding: 12px 16px;
            border-radius: 16px 4px 16px 16px;
            max-width: 85%;
            font-size: 14px;
            line-height: 1.6;
        }

        .chat-typing {
            align-self: flex-start;
            background: white;
            padding: 12px 20px;
            border-radius: 4px 16px 16px 16px;
            display: flex;
            gap: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .chat-typing span {
            width: 8px;
            height: 8px;
            background: #3b82f6;
            border-radius: 50%;
            animation: typingDot 1.4s infinite;
        }

        .chat-typing span:nth-child(2) { animation-delay: 0.2s; }
        .chat-typing span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingDot {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-6px); opacity: 1; }
        }

        .chat-suggestion {
            display: inline-block;
            padding: 8px 14px;
            background: white;
            border: 1px solid #3b82f6;
            color: #1e40af;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-suggestion:hover {
            background: #3b82f6;
            color: white;
        }

        .chat-msg-bot strong {
            color: #1e40af;
        }

        .chat-msg-bot ul, .chat-msg-bot ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .chat-msg-bot li {
            margin-bottom: 4px;
        }

        .chat-time {
            font-size: 10px;
            color: #9ca3af;
            margin-top: 4px;
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- Configuration Firebase -->
    <script src="app/js/config.js"></script>

    <!-- Initialisation Firebase IMM√âDIATE -->
    <script>
        console.log('üîµ Initialisation Firebase en cours...');

        // V√©rifier que FIREBASE_CONFIG existe
        if (typeof FIREBASE_CONFIG === 'undefined') {
            console.error('‚ùå FIREBASE_CONFIG non d√©fini!');
        } else {
            console.log('‚úÖ FIREBASE_CONFIG charg√©');

            // Initialiser Firebase
            if (!firebase.apps.length) {
                firebase.initializeApp(FIREBASE_CONFIG);
                console.log('‚úÖ Firebase.initializeApp() appel√©');
            }

            // Cr√©er les r√©f√©rences GLOBALES
            window.auth = firebase.auth();
            window.db = firebase.firestore();

            console.log('‚úÖ auth et db globaux cr√©√©s');

            // Activer la persistance avec support multi-onglets
            window.db.enablePersistence({ synchronizeTabs: true }).catch((err) => {
                if (err.code === 'failed-precondition') {
                    console.warn('‚ö†Ô∏è Persistance impossible : plusieurs onglets ouverts');
                } else if (err.code === 'unimplemented') {
                    console.warn('‚ö†Ô∏è Persistance non support√©e par ce navigateur');
                }
            });

            console.log('‚úÖ Firebase compl√®tement initialis√©');
        }
    </script>

    <!-- Firebase Init helpers -->
    <script src="app/js/firebase-init.js"></script>

    <!-- Auth Manager -->
    <script src="app/js/auth.js"></script>

    <script>
        let currentUser = null;
        let currentUserData = null;

        // Modal
        function openModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('modal')) closeModal();
        });

        // Settings Modal
        function openSettingsModal() {
            console.log('üîß Ouverture du modal param√®tres...');
            const modal = document.getElementById('settingsModal');

            if (modal) {
                modal.classList.add('active');
                // Charger les donn√©es du profil
                loadProfileData();
                // Afficher l'onglet profil par d√©faut
                showSettingsTab('profile');
                console.log('‚úÖ Modal param√®tres ouvert');
            } else {
                console.error('‚ùå Modal settingsModal non trouv√©!');
            }
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        // Gestion des onglets
        function showSettingsTab(tabName) {
            // Masquer tous les contenus
            document.getElementById('settingsTabProfile').style.display = tabName === 'profile' ? 'block' : 'none';
            document.getElementById('settingsTabSettings').style.display = tabName === 'settings' ? 'block' : 'none';

            // Mettre √† jour les styles des onglets
            const tabProfile = document.getElementById('tabProfile');
            const tabSettings = document.getElementById('tabSettings');

            if (tabName === 'profile') {
                tabProfile.style.color = '#3b82f6';
                tabProfile.style.fontWeight = '600';
                tabProfile.style.borderBottomColor = '#3b82f6';
                tabSettings.style.color = '#6b7280';
                tabSettings.style.fontWeight = '500';
                tabSettings.style.borderBottomColor = 'transparent';
            } else {
                tabSettings.style.color = '#3b82f6';
                tabSettings.style.fontWeight = '600';
                tabSettings.style.borderBottomColor = '#3b82f6';
                tabProfile.style.color = '#6b7280';
                tabProfile.style.fontWeight = '500';
                tabProfile.style.borderBottomColor = 'transparent';
            }
        }

        // Charger les donn√©es du profil
        async function loadProfileData() {
            if (!currentUser || !currentUserData) {
                console.warn('Utilisateur non connect√©');
                return;
            }

            // Avatar avec initiales
            const initials = ((currentUserData.prenom || 'U').charAt(0) + (currentUserData.nom || '').charAt(0)).toUpperCase();
            document.getElementById('profileAvatar').textContent = initials;

            // Nom complet et email
            const fullName = ((currentUserData.prenom || '') + ' ' + (currentUserData.nom || '')).trim() || 'Utilisateur';
            document.getElementById('profileFullName').textContent = fullName;
            document.getElementById('profileEmail').textContent = currentUser.email || '-';

            // Statistiques
            try {
                const tpResult = await DataManager.tp.getAll(true);
                document.getElementById('profileStatTP').textContent = tpResult.data?.length || 0;
            } catch(e) {
                document.getElementById('profileStatTP').textContent = '0';
            }

            // Jours depuis inscription
            if (currentUserData.dateCreation) {
                try {
                    const dateCreation = currentUserData.dateCreation.toDate ? currentUserData.dateCreation.toDate() : new Date(currentUserData.dateCreation);
                    const today = new Date();
                    const diffTime = Math.abs(today - dateCreation);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    document.getElementById('profileStatDays').textContent = diffDays;
                    document.getElementById('profileDateInscription').textContent = 'Membre depuis: ' + dateCreation.toLocaleDateString('fr-FR');
                } catch(e) {
                    document.getElementById('profileStatDays').textContent = '-';
                }
            }

            // Niveau
            document.getElementById('profileStatLevel').textContent = currentUserData.niveau || '-';

            // Pr√©remplir le formulaire d'√©dition
            document.getElementById('editPrenom').value = currentUserData.prenom || '';
            document.getElementById('editNom').value = currentUserData.nom || '';
            document.getElementById('editTelephone').value = currentUserData.telephone || '';
            document.getElementById('editNiveau').value = currentUserData.niveau || '';
            document.getElementById('editGroupe').value = currentUserData.groupe || '';
        }

        // Sauvegarder les modifications du profil
        document.addEventListener('DOMContentLoaded', function() {
            const profileForm = document.getElementById('profileEditForm');
            if (profileForm) {
                profileForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    if (!currentUser) {
                        alert('Vous devez √™tre connect√© pour modifier votre profil');
                        return;
                    }

                    const updatedData = {
                        prenom: document.getElementById('editPrenom').value.trim(),
                        nom: document.getElementById('editNom').value.trim(),
                        telephone: document.getElementById('editTelephone').value.trim(),
                        niveau: document.getElementById('editNiveau').value,
                        groupe: document.getElementById('editGroupe').value.trim(),
                        dateModification: new Date()
                    };

                    try {
                        await window.db.collection('users').doc(currentUser.uid).update(updatedData);

                        // Mettre √† jour les donn√©es locales
                        currentUserData = { ...currentUserData, ...updatedData };

                        // Mettre √† jour l'affichage
                        const fullName = (updatedData.prenom + ' ' + updatedData.nom).trim();
                        document.getElementById('userName').textContent = fullName || 'Utilisateur';
                        document.getElementById('profileFullName').textContent = fullName || 'Utilisateur';
                        document.getElementById('profileStatLevel').textContent = updatedData.niveau || '-';

                        // Mettre √† jour l'avatar
                        const initials = ((updatedData.prenom || 'U').charAt(0) + (updatedData.nom || '').charAt(0)).toUpperCase();
                        document.getElementById('profileAvatar').textContent = initials;

                        alert('‚úÖ Profil mis √† jour avec succ√®s !');
                    } catch(error) {
                        console.error('Erreur mise √† jour profil:', error);
                        alert('‚ùå Erreur: ' + error.message);
                    }
                });
            }
        });

        // Attendre que le DOM soit charg√© pour ajouter l'event listener
        document.addEventListener('DOMContentLoaded', function() {
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal) {
                settingsModal.addEventListener('click', (e) => {
                    if (e.target === settingsModal) closeSettingsModal();
                });
            }
        });

        function resetPassword() {
            const email = currentUser?.email;
            if (email) {
                auth.sendPasswordResetEmail(email)
                    .then(() => alert('Un email de r√©initialisation a √©t√© envoy√© √† ' + email))
                    .catch(e => alert('Erreur: ' + e.message));
            }
        }

        // Voir mes TP
        async function viewMyTP() {
            closeSettingsModal();
            switchSection('tp');
            // Afficher la liste de mes TP dans un modal
            if (!currentUser) {
                alert('Connectez-vous pour voir vos TP');
                return;
            }
            const result = await DataManager.tp.getAll(true); // true = mes TP seulement
            const mesTP = result.data || [];

            if (mesTP.length === 0) {
                openModal('Mes TP', '<p style="text-align: center; color: #6b7280; padding: 20px;">Vous n\'avez pas encore de TP. Cr√©ez votre premier TP!</p>');
                return;
            }

            const content = mesTP.map(tp => `
                <div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #3b82f6;">
                    <strong style="color: #1e40af;">${tp.titre}</strong><br>
                    <span style="font-size: 12px; color: #6b7280;">Type: ${tp.type} | Dur√©e: ${tp.duree}h | Statut: ${tp.statut || 'En cours'}</span>
                </div>
            `).join('');
            openModal('Mes TP (' + mesTP.length + ')', content);
        }

        // Exporter mes donn√©es
        async function exportMyData() {
            if (!currentUser) {
                alert('Connectez-vous pour exporter vos donn√©es');
                return;
            }

            const result = await DataManager.tp.getAll(true);
            const mesTP = result.data || [];

            const exportData = {
                utilisateur: {
                    nom: currentUserData?.nom || '',
                    prenom: currentUserData?.prenom || '',
                    email: currentUser.email
                },
                mesTP: mesTP,
                dateExport: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mes-donnees-esig-' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);

            alert('Vos donn√©es ont √©t√© export√©es avec succ√®s!');
        }

        // Changer le th√®me
        function setTheme(theme) {
            if (theme === 'dark') {
                document.body.style.background = 'linear-gradient(to bottom, #1e293b 0%, #0f172a 100%)';
                document.body.style.color = '#f1f5f9';
                localStorage.setItem('esig_theme', 'dark');
            } else {
                document.body.style.background = 'linear-gradient(to bottom, #ffffff 0%, #2563eb 100%)';
                document.body.style.color = '#1e293b';
                localStorage.setItem('esig_theme', 'light');
            }
        }

        // Charger le th√®me au d√©marrage
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('esig_theme');
            if (savedTheme) {
                setTheme(savedTheme);
            }
        });

        // V√©rifier si mode visiteur
        function isVisitorMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const visitorParam = urlParams.get('mode') === 'visitor';
            const visitorStorage = localStorage.getItem('visitorMode') === 'true';
            return visitorParam || visitorStorage;
        }

        // Configuration du mode visiteur
        function setupVisitorMode() {
            console.log('üëÅÔ∏è Mode visiteur activ√©');

            const loader = document.getElementById('auth-loader');
            const app = document.getElementById('app-content');

            // Masquer les √©l√©ments r√©serv√©s aux utilisateurs connect√©s
            document.getElementById('userName').textContent = 'Visiteur';

            // Masquer bouton admin et settings
            const adminBtn = document.getElementById('adminBtn');
            if (adminBtn) adminBtn.style.display = 'none';

            // Changer le bouton d√©connexion en bouton connexion
            const logoutBtn = document.querySelector('[onclick="logout()"]');
            if (logoutBtn) {
                logoutBtn.setAttribute('onclick', 'goToLogin()');
                logoutBtn.setAttribute('title', 'Se connecter');
                logoutBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i>';
            }

            // Masquer le formulaire de cr√©ation de TP
            const tpForm = document.getElementById('tpForm');
            if (tpForm) {
                tpForm.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #f8fafc; border-radius: 12px;">
                        <i class="fas fa-lock" style="font-size: 48px; color: #9ca3af; margin-bottom: 16px;"></i>
                        <h3 style="color: #374151; margin-bottom: 12px;">Connexion requise</h3>
                        <p style="color: #6b7280; margin-bottom: 20px;">Connectez-vous pour cr√©er des travaux pratiques</p>
                        <button onclick="goToLogin()" class="btn-primary">
                            <i class="fas fa-sign-in-alt"></i> Se connecter
                        </button>
                    </div>
                `;
            }

            // Afficher l'application
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                    if (app) app.style.display = 'flex';
                }, 300);
            }

            // Charger les donn√©es en lecture seule
            loadDataVisitor();
        }

        // Charger les donn√©es pour le mode visiteur (lecture seule)
        async function loadDataVisitor() {
            console.log('üìä Chargement donn√©es visiteur...');

            // V√©rifier que db est disponible
            if (!window.db) {
                console.error('‚ùå db non disponible pour le mode visiteur');
                document.getElementById('statMachines').textContent = '-';
                document.getElementById('statStock').textContent = '-';
                document.getElementById('statTP').textContent = 'üîí';
                document.getElementById('statMaintenance').textContent = 'üîí';
                return;
            }

            try {
                // Charger les machines (public)
                console.log('üì¶ Chargement machines...');
                const machSnapshot = await window.db.collection('machines').get();
                const machines = [];
                machSnapshot.forEach(doc => machines.push({ id: doc.id, ...doc.data() }));
                document.getElementById('statMachines').textContent = machines.length;
                console.log('‚úÖ Machines:', machines.length);

                // Charger le stock (public)
                console.log('üì¶ Chargement stock...');
                const stockSnapshot = await window.db.collection('stocks').get();
                const stocks = [];
                stockSnapshot.forEach(doc => stocks.push({ id: doc.id, ...doc.data() }));
                document.getElementById('statStock').textContent = stocks.length;
                console.log('‚úÖ Stock:', stocks.length);

                // TP et maintenance affichent une ic√¥ne verrou pour visiteur
                document.getElementById('statTP').textContent = 'üîí';
                document.getElementById('statMaintenance').textContent = 'üîí';

                console.log('‚úÖ Donn√©es visiteur charg√©es avec succ√®s');
            } catch (error) {
                console.error('‚ùå Erreur chargement donn√©es visiteur:', error);
                // Afficher des tirets en cas d'erreur
                document.getElementById('statMachines').textContent = '-';
                document.getElementById('statStock').textContent = '-';
                document.getElementById('statTP').textContent = 'üîí';
                document.getElementById('statMaintenance').textContent = 'üîí';
            }
        }

        function goToLogin() {
            localStorage.removeItem('visitorMode');
            window.location.href = 'login.html';
        }

        // Fonction pour aller au panel admin
        function adminPanel() {
            console.log('üîë Acc√®s au panel admin...');
            window.location.href = 'admin.html';
        }

        // Fonction de d√©connexion
        function logout() {
            console.log('üö™ D√©connexion...');
            if (window.auth) {
                window.auth.signOut().then(() => {
                    localStorage.removeItem('visitorMode');
                    window.location.href = 'login.html';
                }).catch(err => {
                    console.error('Erreur d√©connexion:', err);
                    window.location.href = 'login.html';
                });
            } else {
                window.location.href = 'login.html';
            }
        }

        // Flag pour savoir si c'est le premier chargement
        let isInitialAuthCheck = true;

        // Auth - V√©rifier l'authentification avec Firebase directement
        auth.onAuthStateChanged(async (user) => {
            console.log('üîç V√©rification auth:', { user: user?.email, visitorMode: isVisitorMode(), isInitial: isInitialAuthCheck });

            // Si mode visiteur, ne pas rediriger vers login
            if (!user && isVisitorMode()) {
                setupVisitorMode();
                isInitialAuthCheck = false;
                return;
            }

            if (!user) {
                // Ne rediriger que lors du premier chargement
                if (isInitialAuthCheck) {
                    console.log('‚ùå Pas de user -> redirection login');
                    window.location.href = 'login.html';
                } else {
                    console.log('‚ö†Ô∏è D√©connexion d√©tect√©e depuis un autre onglet - ignor√©e');
                }
                isInitialAuthCheck = false;
                return;
            }

            if (user) {
                console.log('‚úÖ User trouv√©:', user.email);
                currentUser = user;
                // Charger les donn√©es utilisateur depuis Firestore
                const loader = document.getElementById('auth-loader');
                const app = document.getElementById('app-content');
                try {
                    const doc = await db.collection('users').doc(user.uid).get();

                    if (doc.exists) {
                        const data = doc.data();
                        // Stocker les donn√©es utilisateur globalement
                        currentUserData = { id: doc.id, ...data };

                        const userNameEl = document.getElementById('userName');
                        if (userNameEl && data.prenom && data.nom) {
                            userNameEl.textContent = `${data.prenom} ${data.nom}`;
                        }

                        // Gestion du r√¥le (si l'√©l√©ment existe)
                        const userRoleEl = document.getElementById('userRole');
                        if (userRoleEl && data.role) {
                            userRoleEl.textContent = data.role.toUpperCase();
                        }

                        // Afficher le bouton Admin si l'utilisateur est admin
                        const adminBtn = document.getElementById('adminBtn');
                        if (adminBtn && data.role && data.role.toLowerCase() === 'admin') {
                            adminBtn.style.display = 'flex';
                            console.log('‚úÖ Bouton Admin affich√©');
                        }

                        // Afficher le contenu
                        if (loader) {
                            loader.style.opacity = '0';
                            setTimeout(() => {
                                loader.style.display = 'none';
                                if (app) app.style.display = 'flex';
                            }, 500);
                        }
                    }
                } catch (error) {
                    console.error('Erreur chargement donn√©es:', error);
                }
                console.log('üìä Chargement des donn√©es...');
                loadData();
            }
        });

        // Navigation
        function switchSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(section + 'Section').classList.add('active');
            document.querySelector('[data-nav="' + section + '"]').classList.add('active');

            if (section === 'machines') loadMachines();
            else if (section === 'stock') loadStock();
            else if (section === 'maintenance') loadMaintenance();
            else if (section === 'securite') loadSecuriteUser();
        }

        // Load stats et afficher les TP de l'utilisateur
        async function loadData() {
            const tp = await DataManager.tp.getAll(true); // Mes TP seulement
            const mach = await DataManager.machines.getAll();
            const stock = await DataManager.stocks.getAll();
            const maint = await DataManager.maintenance.getAll();

            document.getElementById('statTP').textContent = tp.data ? tp.data.length : 0;
            document.getElementById('statMachines').textContent = mach.data ? mach.data.length : 0;
            document.getElementById('statStock').textContent = stock.data ? stock.data.length : 0;
            document.getElementById('statMaintenance').textContent = maint.data ? maint.data.length : 0;

            // Afficher mes TP dans la liste
            displayMyTP(tp.data || []);
        }

        // Afficher mes TP
        function displayMyTP(tpList) {
            const container = document.getElementById('myTPList');
            const countEl = document.getElementById('myTPCount');

            if (countEl) {
                countEl.textContent = tpList.length;
            }

            if (tpList.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #f8fafc; border-radius: 12px; border: 2px dashed #e5e7eb;">
                        <i class="fas fa-folder-open" style="font-size: 48px; color: #9ca3af; margin-bottom: 12px;"></i>
                        <h4 style="color: #374151; margin-bottom: 8px;">Aucun TP pour l'instant</h4>
                        <p style="color: #6b7280; font-size: 14px;">Cr√©ez votre premier TP en utilisant le formulaire ci-dessous</p>
                    </div>
                `;
                return;
            }

            const html = tpList.map(tp => {
                // Formater la date et l'heure
                let dateStr = '-';
                let heureStr = '-';
                let tpDate = null;
                if (tp.dateDebut) {
                    try {
                        tpDate = tp.dateDebut.toDate ? tp.dateDebut.toDate() : new Date(tp.dateDebut);
                        dateStr = tpDate.toLocaleDateString('fr-FR');
                        heureStr = tp.heureDebut || tpDate.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
                    } catch(e) {}
                }

                // Calculer le statut dynamique bas√© sur l'heure actuelle
                const now = new Date();
                let statut = tp.statut || 'planifie';

                if (tpDate && tp.duree) {
                    const dateFin = new Date(tpDate.getTime() + (tp.duree * 60 * 60 * 1000));
                    if (now < tpDate) {
                        statut = 'planifie';
                    } else if (now >= tpDate && now < dateFin) {
                        statut = 'en_cours';
                    } else {
                        statut = 'termine';
                    }
                }

                // Badge de statut
                let statusColor = '#fef3c7';
                let statusText = 'En attente';
                let statusTextColor = '#92400e';

                if (statut === 'en_cours') {
                    statusColor = '#d1fae5';
                    statusText = 'En cours';
                    statusTextColor = '#065f46';
                } else if (statut === 'termine') {
                    statusColor = '#dbeafe';
                    statusText = 'Termin√©';
                    statusTextColor = '#1e40af';
                }

                // Bouton terminer (seulement si pas encore termin√©)
                const showEndButton = statut !== 'termine';

                // Couleur de la bordure selon le statut
                let borderColor = '#f59e0b'; // Orange pour en attente
                if (statut === 'en_cours') borderColor = '#3b82f6'; // Bleu pour en cours
                if (statut === 'termine') borderColor = '#10b981'; // Vert pour termin√©

                return `
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 12px; transition: all 0.3s; border-left: 4px solid ${borderColor};"
                         onmouseover="this.style.boxShadow='0 8px 16px rgba(59,130,246,0.15)'; this.style.transform='translateY(-2px)'"
                         onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <div style="cursor: pointer; flex: 1;" onclick="viewTPDetail('${tp.id}')">
                                <h4 style="color: #1e40af; margin: 0 0 4px 0;">${tp.titre}</h4>
                                <p style="font-size: 13px; color: #6b7280; margin: 0;">
                                    <i class="fas fa-tag" style="margin-right: 4px;"></i> ${tp.type || 'Non d√©fini'}
                                    <span style="margin: 0 8px;">‚Ä¢</span>
                                    <i class="fas fa-calendar" style="margin-right: 4px;"></i> ${dateStr} √† ${heureStr}
                                    <span style="margin: 0 8px;">‚Ä¢</span>
                                    <i class="fas fa-clock" style="margin-right: 4px;"></i> ${tp.duree || '-'}h
                                </p>
                            </div>
                            <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: ${statusColor}; color: ${statusTextColor};">${statusText}</span>
                        </div>
                        ${tp.description ? `<p style="font-size: 13px; color: #4b5563; margin: 8px 0 0 0; line-height: 1.5; cursor: pointer;" onclick="viewTPDetail('${tp.id}')">${tp.description.substring(0, 100)}${tp.description.length > 100 ? '...' : ''}</p>` : ''}
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px;">
                                <i class="fas fa-users" style="color: #6b7280;"></i>
                                <span style="font-size: 12px; color: #6b7280;">${(tp.membres || []).length} membre(s)</span>
                                <button onclick="event.stopPropagation(); gererMembresTP('${tp.id}', '${tp.titre}')" style="margin-left: auto; padding: 4px 10px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 11px; cursor: pointer;">
                                    <i class="fas fa-user-plus"></i> G√©rer
                                </button>
                            </div>
                        </div>
                        ${showEndButton ? `
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button onclick="event.stopPropagation(); terminerTP('${tp.id}')" style="padding: 8px 16px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; font-size: 13px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-check-circle"></i> Terminer
                            </button>
                            <button onclick="event.stopPropagation(); supprimerMonTP('${tp.id}')" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 13px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                        </div>
                        ` : `
                        <div>
                            <span style="padding: 6px 12px; background: #d1fae5; color: #065f46; border-radius: 8px; font-size: 12px; font-weight: 500;">
                                <i class="fas fa-check"></i> TP termin√©
                            </span>
                        </div>
                        `}
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // Terminer un TP
        async function terminerTP(tpId) {
            if (!confirm('Voulez-vous marquer ce TP comme termin√© ?')) return;

            try {
                await window.db.collection('TP').doc(tpId).update({
                    statut: 'termine',
                    dateFin: new Date()
                });

                // Notification
                showUserNotification('TP marqu√© comme termin√© !', 'success');

                // Recharger les donn√©es
                loadData();
            } catch(error) {
                console.error('Erreur terminer TP:', error);
                showUserNotification('Erreur: ' + error.message, 'error');
            }
        }

        // Supprimer mon TP
        async function supprimerMonTP(tpId) {
            if (!confirm('Voulez-vous vraiment supprimer ce TP ? Cette action est irr√©versible.')) return;

            try {
                await window.db.collection('TP').doc(tpId).delete();

                // Notification
                showUserNotification('TP supprim√© avec succ√®s', 'success');

                // Recharger les donn√©es
                loadData();
            } catch(error) {
                console.error('Erreur suppression TP:', error);
                showUserNotification('Erreur: ' + error.message, 'error');
            }
        }

        // Notification pour utilisateur
        function showUserNotification(message, type = 'info') {
            const notif = document.createElement('div');
            notif.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 14px 20px;
                border-radius: 10px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                box-shadow: 0 8px 24px rgba(0,0,0,0.2);
                animation: slideIn 0.3s ease;
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 14px;
            `;

            if (type === 'success') {
                notif.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                notif.innerHTML = '<i class="fas fa-check-circle"></i> ' + message;
            } else if (type === 'error') {
                notif.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                notif.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + message;
            } else {
                notif.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
                notif.innerHTML = '<i class="fas fa-info-circle"></i> ' + message;
            }

            document.body.appendChild(notif);

            setTimeout(() => {
                notif.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        // Voir le d√©tail d'un TP
        async function viewTPDetail(tpId) {
            const result = await DataManager.tp.getById(tpId);
            if (!result.success) {
                alert('Erreur: ' + result.error);
                return;
            }

            const tp = result.data;

            // Formater la date
            let dateStr = '-';
            if (tp.dateDebut) {
                try {
                    const date = tp.dateDebut.toDate ? tp.dateDebut.toDate() : new Date(tp.dateDebut);
                    dateStr = date.toLocaleDateString('fr-FR');
                } catch(e) {}
            }

            const content = `
                <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                    <p style="margin: 8px 0;"><strong>Type:</strong> ${tp.type || 'Non d√©fini'}</p>
                    <p style="margin: 8px 0;"><strong>Date de d√©but:</strong> ${dateStr}</p>
                    <p style="margin: 8px 0;"><strong>Dur√©e:</strong> ${tp.duree || '-'} heures</p>
                    <p style="margin: 8px 0;"><strong>Statut:</strong> ${tp.statut || 'En cours'}</p>
                </div>
                ${tp.description ? `<div style="margin-bottom: 16px;"><strong>Description:</strong><p style="color: #4b5563; margin-top: 8px; line-height: 1.6;">${tp.description}</p></div>` : ''}
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="closeModal(); editMyTP('${tp.id}')" class="btn-primary" style="flex: 1;">
                        <i class="fas fa-edit"></i> Modifier
                    </button>
                </div>
            `;

            openModal(tp.titre, content);
        }

        // √âditer un TP (placeholder)
        function editMyTP(tpId) {
            alert('Fonction d\'√©dition √† impl√©menter. ID du TP: ' + tpId);
        }

        // TP Form
        document.getElementById('tpForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUser) {
                alert('Connectez-vous d\'abord');
                window.location.href = 'login.html';
                return;
            }

            // Combiner date et heure de d√©but
            const dateStr = document.getElementById('tpDateDebut').value;
            const heureStr = document.getElementById('tpHeureDebut').value;
            const dateDebut = new Date(dateStr + 'T' + heureStr);

            // Calculer le statut initial bas√© sur l'heure actuelle
            const now = new Date();
            const dureeHeures = parseFloat(document.getElementById('tpDuree').value);
            const dateFin = new Date(dateDebut.getTime() + (dureeHeures * 60 * 60 * 1000));

            let statut = 'planifie'; // En attente par d√©faut
            if (now >= dateDebut && now < dateFin) {
                statut = 'en_cours';
            } else if (now >= dateFin) {
                statut = 'termine';
            }

            const result = await DataManager.tp.create({
                titre: document.getElementById('tpTitre').value,
                type: document.getElementById('tpType').value,
                dateDebut: dateDebut,
                heureDebut: heureStr,
                duree: dureeHeures,
                dateFin: dateFin,
                description: document.getElementById('tpDescription').value,
                createdBy: currentUser.uid,
                statut: statut,
                membres: [currentUser.uid]
            });

            const alertEl = document.getElementById('tpAlert');
            if (result.success) {
                alertEl.className = 'alert show success';
                alertEl.textContent = '‚úì TP cr√©√© avec succ√®s !';
                document.getElementById('tpForm').reset();
                loadData();
                setTimeout(() => alertEl.classList.remove('show'), 3000);
            } else {
                alertEl.className = 'alert show error';
                alertEl.textContent = '‚úó Erreur: ' + result.error;
            }
        });

        // Machines
        async function loadMachines() {
            const result = await DataManager.machines.getAll();
            const data = result.data || [];
            document.getElementById('machinesCount').textContent = data.length;

            if (data.length === 0) {
                document.getElementById('machinesContent').innerHTML = '<p style="text-align:center; color:#9ca3af; padding:40px;">Aucune machine</p>';
                return;
            }

            displayMachines(data);

            document.getElementById('machinesSearch').addEventListener('input', () => displayMachines(data));
            document.getElementById('machinesFilter').addEventListener('change', () => displayMachines(data));
        }

        function displayMachines(data) {
            const search = document.getElementById('machinesSearch').value.toLowerCase();
            const filter = document.getElementById('machinesFilter').value.toLowerCase();

            const filtered = data.filter(m => {
                const matchSearch = !search || m.nom?.toLowerCase().includes(search) || m.type?.toLowerCase().includes(search);
                const matchFilter = !filter || m.statut?.toLowerCase().includes(filter);
                return matchSearch && matchFilter;
            });

            if (filtered.length === 0) {
                document.getElementById('machinesContent').innerHTML = '<p style="text-align:center; color:#9ca3af; padding:40px;">Aucun r√©sultat</p>';
                return;
            }

            document.getElementById('machinesContent').innerHTML = filtered.map(m => {
                const statut = m.statut?.toLowerCase() || 'inconnu';
                let badge = '‚úì Disponible', color = '#d1fae5';
                if (statut.includes('maintenance')) { badge = '‚öô Maintenance'; color = '#fef3c7'; }
                else if (statut.includes('panne')) { badge = '‚úó Panne'; color = '#fee2e2'; }

                return `
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.boxShadow='0 8px 16px rgba(59,130,246,0.1)'; this.style.borderColor='#3b82f6'" onmouseout="this.style.boxShadow='none'; this.style.borderColor='#e5e7eb'" onclick="openModal('${m.nom}', '<p><strong>Type:</strong> ${m.type || 'N/A'}</p><p><strong>Lieu:</strong> ${m.lieu || 'N/A'}</p><p><strong>Heures:</strong> ${m.nombreHeuresUtilisation || 0}h</p>${m.description ? '<p><strong>Description:</strong> ' + m.description + '</p>' : ''}')">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h4 style="color: #1e40af; margin: 0;">${m.nom}</h4>
                            <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: ${color};">${badge}</span>
                        </div>
                        <p style="font-size: 13px; color: #6b7280; margin: 0;">Type: ${m.type} ‚Ä¢ Lieu: ${m.lieu} ‚Ä¢ Heures: ${m.nombreHeuresUtilisation || 0}h</p>
                    </div>
                `;
            }).join('');
        }

        // Stock
        async function loadStock() {
            const result = await DataManager.stocks.getAll();
            const data = result.data || [];
            document.getElementById('stockCount').textContent = data.length;

            if (data.length === 0) {
                document.getElementById('stockContent').innerHTML = '<p style="text-align:center; color:#9ca3af; padding:40px;">Aucun article</p>';
                return;
            }

            displayStock(data);

            document.getElementById('stockSearch').addEventListener('input', () => displayStock(data));
            document.getElementById('stockFilter').addEventListener('change', () => displayStock(data));
        }

        function displayStock(data) {
            const search = document.getElementById('stockSearch').value.toLowerCase();
            const filter = document.getElementById('stockFilter').value.toLowerCase();

            const filtered = data.filter(s => {
                const matchSearch = !search || s.nom?.toLowerCase().includes(search) || s.categorie?.toLowerCase().includes(search);
                const q = parseFloat(s.quantite || 0);
                const min = parseFloat(s.quantiteMinimale || 10);
                let status = 'normal';
                if (q <= 0) status = 'critique';
                else if (q <= min) status = 'faible';
                const matchFilter = !filter || status.includes(filter);
                return matchSearch && matchFilter;
            });

            if (filtered.length === 0) {
                document.getElementById('stockContent').innerHTML = '<p style="text-align:center; color:#9ca3af; padding:40px;">Aucun r√©sultat</p>';
                return;
            }

            document.getElementById('stockContent').innerHTML = filtered.map(s => {
                const q = parseFloat(s.quantite || 0);
                const min = parseFloat(s.quantiteMinimale || 10);
                let badge = '‚úì OK', color = '#d1fae5';
                if (q <= 0) { badge = '‚ö† Rupture'; color = '#fee2e2'; }
                else if (q <= min) { badge = '‚ö† Faible'; color = '#fef3c7'; }

                return `
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 12px; cursor: pointer;" onmouseover="this.style.boxShadow='0 8px 16px rgba(59,130,246,0.1)'; this.style.borderColor='#3b82f6'" onmouseout="this.style.boxShadow='none'; this.style.borderColor='#e5e7eb'" onclick="openModal('${s.nom}', '<p><strong>Cat√©gorie:</strong> ${s.categorie || 'N/A'}</p><p><strong>Quantit√©:</strong> ${q}</p><p><strong>Minimum:</strong> ${min}</p><p><strong>Prix:</strong> ${s.prix ? s.prix.toFixed(2) : '0'}‚Ç¨</p>')">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h4 style="color: #1e40af; margin: 0;">${s.nom}</h4>
                            <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: ${color};">${badge}</span>
                        </div>
                        <p style="font-size: 13px; color: #6b7280; margin: 0;">Cat√©gorie: ${s.categorie} ‚Ä¢ Quantit√©: ${q}/${min} ‚Ä¢ Prix: ${s.prix || 0}‚Ç¨</p>
                        <div style="width: 100%; height: 6px; background: #e5e7eb; border-radius: 3px; margin-top: 8px; overflow: hidden;">
                            <div style="height: 100%; background: linear-gradient(90deg, #3b82f6, #2563eb); width: ${Math.min(100, (q / min) * 100)}%;"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Maintenance
        async function loadMaintenance() {
            const result = await DataManager.maintenance.getAll();
            const data = result.data || [];
            document.getElementById('maintenanceCount').textContent = data.length;

            if (data.length === 0) {
                document.getElementById('maintenanceContent').innerHTML = '<p style="text-align:center; color:#9ca3af; padding:40px;">Aucune maintenance</p>';
                return;
            }

            displayMaintenance(data);

            document.getElementById('maintenanceSearch').addEventListener('input', () => displayMaintenance(data));
            document.getElementById('maintenanceFilter').addEventListener('change', () => displayMaintenance(data));
        }

        function displayMaintenance(data) {
            const search = document.getElementById('maintenanceSearch').value.toLowerCase();
            const filter = document.getElementById('maintenanceFilter').value.toLowerCase();

            const filtered = data.filter(m => {
                const matchSearch = !search || m.machineId?.toLowerCase().includes(search) || m.type?.toLowerCase().includes(search);
                const matchFilter = !filter || m.statut?.toLowerCase().includes(filter);
                return matchSearch && matchFilter;
            });

            if (filtered.length === 0) {
                document.getElementById('maintenanceContent').innerHTML = '<p style="text-align:center; color:#9ca3af; padding:40px;">Aucun r√©sultat</p>';
                return;
            }

            document.getElementById('maintenanceContent').innerHTML = filtered.map(m => {
                const statut = m.statut?.toLowerCase() || 'planifi√©e';
                let badge = 'üîµ Planifi√©e', color = '#dbeafe';
                if (statut.includes('urgent')) { badge = 'üî¥ Urgent'; color = '#fee2e2'; }
                else if (statut.includes('cours')) { badge = 'üü† En cours'; color = '#fef3c7'; }

                return `
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 12px; cursor: pointer;" onmouseover="this.style.boxShadow='0 8px 16px rgba(59,130,246,0.1)'; this.style.borderColor='#3b82f6'" onmouseout="this.style.boxShadow='none'; this.style.borderColor='#e5e7eb'" onclick="openModal('Maintenance', '<p><strong>Machine:</strong> ${m.machineId || 'N/A'}</p><p><strong>Type:</strong> ${m.type || 'N/A'}</p><p><strong>Statut:</strong> ${m.statut || 'N/A'}</p><p><strong>Dur√©e:</strong> ${m.dureePrevue || 'N/A'}</p><p><strong>Date:</strong> ${m.dateDebut ? new Date(m.dateDebut).toLocaleDateString('fr-FR') : 'N/A'}</p>${m.description ? '<p><strong>Description:</strong> ' + m.description + '</p>' : ''}')">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h4 style="color: #1e40af; margin: 0;">Maintenance</h4>
                            <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: ${color};">${badge}</span>
                        </div>
                        <p style="font-size: 13px; color: #6b7280; margin: 0;">Machine: ${m.machineId} ‚Ä¢ Type: ${m.type} ‚Ä¢ Date: ${m.dateDebut ? new Date(m.dateDebut).toLocaleDateString('fr-FR') : 'N/A'}</p>
                    </div>
                `;
            }).join('');
        }

        function adminPanel() {
            window.location.href = 'admin.html';
        }

        async function logout() {
            if (confirm('Vous √™tes s√ªr ?')) {
                await auth.signOut();
                localStorage.removeItem('visitMode');
                window.location.href = 'login.html';
            }
        }

        // ==========================================
        // FONCTIONS S√âCURIT√â UTILISATEUR
        // ==========================================

        async function loadSecuriteUser() {
            await Promise.all([
                loadUserAlertes(),
                loadUserConsignesGenerales(),
                loadUserZones(),
                loadUserConsignesMachines()
            ]);
        }

        async function loadUserAlertes() {
            try {
                const now = new Date();
                const snapshot = await db.collection('alertes')
                    .where('destinataires', 'in', ['tous', 'etudiants'])
                    .get();

                const alertes = snapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(a => {
                        const dateActivation = a.dateActivation?.toDate ? a.dateActivation.toDate() : new Date(a.dateActivation);
                        return dateActivation <= now;
                    });

                if (alertes.length > 0) {
                    const prioriteColors = {
                        'basse': { bg: '#dbeafe', color: '#1e40af', icon: 'fa-info-circle' },
                        'moyenne': { bg: '#fef3c7', color: '#92400e', icon: 'fa-exclamation-triangle' },
                        'haute': { bg: '#fed7aa', color: '#c2410c', icon: 'fa-exclamation-circle' },
                        'critique': { bg: '#fecaca', color: '#991b1b', icon: 'fa-skull-crossbones' }
                    };

                    const html = alertes.map(a => {
                        const p = prioriteColors[a.priorite] || prioriteColors['moyenne'];
                        return `
                            <div style="background: ${p.bg}; border-radius: 12px; padding: 14px; margin-bottom: 10px; border-left: 4px solid ${p.color};">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="fas ${p.icon}" style="color: ${p.color}; font-size: 20px;"></i>
                                    <div>
                                        <strong style="color: ${p.color};">${a.titre}</strong>
                                        <p style="color: ${p.color}; margin: 4px 0 0 0; font-size: 13px; opacity: 0.9;">${a.message}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    document.getElementById('userAlertesSecurite').innerHTML = html;
                } else {
                    document.getElementById('userAlertesSecurite').innerHTML = '';
                }
            } catch(e) {
                console.error('Erreur chargement alertes:', e);
                document.getElementById('userAlertesSecurite').innerHTML = '';
            }
        }

        async function loadUserConsignesGenerales() {
            try {
                const snapshot = await db.collection('consignes')
                    .where('type', '==', 'generale')
                    .get();

                const consignes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (consignes.length > 0) {
                    const niveauStyles = {
                        'info': { bg: '#dbeafe', color: '#1e40af', icon: 'fa-info-circle' },
                        'attention': { bg: '#fef3c7', color: '#92400e', icon: 'fa-exclamation-triangle' },
                        'danger': { bg: '#fee2e2', color: '#991b1b', icon: 'fa-exclamation-circle' },
                        'critique': { bg: '#fecaca', color: '#7f1d1d', icon: 'fa-skull-crossbones' }
                    };

                    const html = consignes.map(c => {
                        const style = niveauStyles[c.niveau] || niveauStyles['info'];
                        return `
                            <div style="background: ${style.bg}; border-radius: 10px; padding: 12px; margin-bottom: 10px;">
                                <div style="display: flex; align-items: start; gap: 10px;">
                                    <i class="fas ${style.icon}" style="color: ${style.color}; margin-top: 2px;"></i>
                                    <div>
                                        <strong style="color: ${style.color};">${c.titre}</strong>
                                        <p style="color: ${style.color}; margin: 4px 0 0 0; font-size: 13px; opacity: 0.85;">${c.description || ''}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    document.getElementById('consignesGenerales').innerHTML = html;
                } else {
                    document.getElementById('consignesGenerales').innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 20px;">Aucune consigne g√©n√©rale d√©finie</p>';
                }
            } catch(e) {
                console.error('Erreur chargement consignes g√©n√©rales:', e);
            }
        }

        async function loadUserZones() {
            try {
                const snapshot = await db.collection('zones').orderBy('nom').get();
                const zones = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (zones.length > 0) {
                    const risqueColors = {
                        'faible': { bg: '#d1fae5', color: '#065f46' },
                        'moyen': { bg: '#fef3c7', color: '#92400e' },
                        'eleve': { bg: '#fee2e2', color: '#991b1b' }
                    };

                    const html = zones.map(z => {
                        const risque = risqueColors[z.risque] || risqueColors['faible'];
                        const epiIcons = [];
                        if (z.epiLunettes) epiIcons.push('<span title="Lunettes">üëì</span>');
                        if (z.epiGants) epiIcons.push('<span title="Gants">üß§</span>');
                        if (z.epiCasque) epiIcons.push('<span title="Casque">‚õëÔ∏è</span>');
                        if (z.epiChaussures) epiIcons.push('<span title="Chaussures">üëü</span>');
                        if (z.epiAuditif) epiIcons.push('<span title="Protection auditive">üéß</span>');
                        if (z.epiBlouse) epiIcons.push('<span title="Blouse">ü•º</span>');

                        return `
                            <div style="background: #f8fafc; border-radius: 10px; padding: 12px; margin-bottom: 10px; border: 1px solid #e5e7eb;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <strong style="color: #1e40af;"><i class="fas fa-map-marker-alt"></i> ${z.nom}</strong>
                                    <span style="background: ${risque.bg}; color: ${risque.color}; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600;">Risque ${z.risque}</span>
                                </div>
                                ${z.description ? `<p style="color: #6b7280; font-size: 13px; margin: 0 0 8px 0;">${z.description}</p>` : ''}
                                ${epiIcons.length > 0 ? `
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <span style="font-size: 12px; color: #6b7280;">EPI requis:</span>
                                        <span style="font-size: 18px;">${epiIcons.join(' ')}</span>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                    document.getElementById('zonesSecurite').innerHTML = html;
                } else {
                    document.getElementById('zonesSecurite').innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 20px;">Aucune zone d√©finie</p>';
                }
            } catch(e) {
                console.error('Erreur chargement zones:', e);
            }
        }

        async function loadUserConsignesMachines() {
            try {
                const snapshot = await db.collection('consignes')
                    .where('type', '==', 'machine')
                    .get();

                const consignes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (consignes.length > 0) {
                    // Grouper par machine
                    const parMachine = {};
                    consignes.forEach(c => {
                        const machine = c.machine || 'Autre';
                        if (!parMachine[machine]) parMachine[machine] = [];
                        parMachine[machine].push(c);
                    });

                    const niveauStyles = {
                        'info': { color: '#3b82f6', icon: 'fa-info-circle' },
                        'attention': { color: '#f59e0b', icon: 'fa-exclamation-triangle' },
                        'danger': { color: '#ef4444', icon: 'fa-exclamation-circle' },
                        'critique': { color: '#991b1b', icon: 'fa-skull-crossbones' }
                    };

                    const html = Object.entries(parMachine).map(([machine, consignesList]) => `
                        <div style="background: #f8fafc; border-radius: 10px; padding: 12px; margin-bottom: 10px; border: 1px solid #e5e7eb;">
                            <h4 style="color: #1e40af; margin: 0 0 10px 0; font-size: 14px;">
                                <i class="fas fa-cog"></i> ${machine}
                            </h4>
                            ${consignesList.map(c => {
                                const style = niveauStyles[c.niveau] || niveauStyles['info'];
                                return `
                                    <div style="display: flex; align-items: start; gap: 8px; padding: 6px 0; border-bottom: 1px solid #e5e7eb;">
                                        <i class="fas ${style.icon}" style="color: ${style.color}; margin-top: 2px;"></i>
                                        <div>
                                            <strong style="color: #374151; font-size: 13px;">${c.titre}</strong>
                                            ${c.description ? `<p style="color: #6b7280; font-size: 12px; margin: 2px 0 0 0;">${c.description}</p>` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `).join('');
                    document.getElementById('consignesMachines').innerHTML = html;
                } else {
                    document.getElementById('consignesMachines').innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 20px;">Aucune consigne par machine</p>';
                }
            } catch(e) {
                console.error('Erreur chargement consignes machines:', e);
            }
        }

        // ==========================================
        // GESTION DES MEMBRES TP
        // ==========================================

        let currentTPId = null;
        let allUsersCache = [];

        async function gererMembresTP(tpId, tpTitle) {
            currentTPId = tpId;
            document.getElementById('membresTPTitle').textContent = 'TP: ' + tpTitle;
            document.getElementById('membresModal').classList.add('active');
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('searchMembre').value = '';

            // Charger les utilisateurs en cache
            if (allUsersCache.length === 0) {
                try {
                    const snapshot = await db.collection('users').get();
                    allUsersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch(e) {
                    console.error('Erreur chargement utilisateurs:', e);
                }
            }

            await loadCurrentMembers();
        }

        function closeMembresModal() {
            document.getElementById('membresModal').classList.remove('active');
            currentTPId = null;
            loadData(); // Rafra√Æchir les donn√©es
        }

        async function loadCurrentMembers() {
            try {
                const tpDoc = await db.collection('TP').doc(currentTPId).get();
                const tp = tpDoc.data();
                const membres = tp.membres || [];

                if (membres.length === 0) {
                    document.getElementById('currentMembers').innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 10px;">Aucun membre pour le moment</p>';
                    return;
                }

                // R√©cup√©rer les infos des membres
                const membresInfo = [];
                for (const uid of membres) {
                    const user = allUsersCache.find(u => u.id === uid);
                    if (user) {
                        membresInfo.push(user);
                    } else {
                        // Essayer de charger depuis Firestore
                        try {
                            const userDoc = await db.collection('users').doc(uid).get();
                            if (userDoc.exists) {
                                membresInfo.push({ id: uid, ...userDoc.data() });
                            }
                        } catch(e) {}
                    }
                }

                const html = membresInfo.map(m => `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6, #1e40af); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">
                                ${(m.prenom || '?')[0]}${(m.nom || '?')[0]}
                            </div>
                            <div>
                                <strong style="color: #1e40af;">${m.prenom || ''} ${m.nom || ''}</strong>
                                <p style="color: #6b7280; font-size: 12px; margin: 0;">${m.email || ''}</p>
                            </div>
                        </div>
                        ${m.id !== currentUser?.uid ? `
                            <button onclick="retirerMembre('${m.id}')" style="padding: 6px 12px; background: #fee2e2; color: #991b1b; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                <i class="fas fa-times"></i> Retirer
                            </button>
                        ` : '<span style="font-size: 11px; color: #10b981; background: #d1fae5; padding: 4px 8px; border-radius: 4px;">Vous</span>'}
                    </div>
                `).join('');

                document.getElementById('currentMembers').innerHTML = html;
            } catch(e) {
                console.error('Erreur chargement membres:', e);
                document.getElementById('currentMembers').innerHTML = '<p style="color: #ef4444;">Erreur de chargement</p>';
            }
        }

        function searchUsers() {
            const query = document.getElementById('searchMembre').value.toLowerCase().trim();
            if (!query) {
                document.getElementById('searchResults').innerHTML = '';
                return;
            }

            const results = allUsersCache.filter(u =>
                (u.nom?.toLowerCase().includes(query) ||
                 u.prenom?.toLowerCase().includes(query) ||
                 u.email?.toLowerCase().includes(query)) &&
                u.id !== currentUser?.uid
            ).slice(0, 5);

            if (results.length === 0) {
                document.getElementById('searchResults').innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 10px;">Aucun r√©sultat</p>';
                return;
            }

            const html = results.map(u => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; background: #eff6ff; border-radius: 6px; margin-bottom: 6px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 32px; height: 32px; border-radius: 50%; background: #3b82f6; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
                            ${(u.prenom || '?')[0]}${(u.nom || '?')[0]}
                        </div>
                        <div>
                            <strong style="color: #1e40af; font-size: 13px;">${u.prenom || ''} ${u.nom || ''}</strong>
                            <p style="color: #6b7280; font-size: 11px; margin: 0;">${u.email || ''}</p>
                        </div>
                    </div>
                    <button onclick="ajouterMembre('${u.id}')" style="padding: 5px 10px; background: #10b981; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 11px;">
                        <i class="fas fa-plus"></i> Ajouter
                    </button>
                </div>
            `).join('');

            document.getElementById('searchResults').innerHTML = html;
        }

        async function ajouterMembre(userId) {
            try {
                await db.collection('TP').doc(currentTPId).update({
                    membres: firebase.firestore.FieldValue.arrayUnion(userId)
                });
                showUserNotification('Membre ajout√© avec succ√®s !', 'success');
                await loadCurrentMembers();
                document.getElementById('searchResults').innerHTML = '';
                document.getElementById('searchMembre').value = '';
            } catch(e) {
                console.error('Erreur ajout membre:', e);
                showUserNotification('Erreur: ' + e.message, 'error');
            }
        }

        async function retirerMembre(userId) {
            if (!confirm('Retirer ce membre du TP ?')) return;

            try {
                await db.collection('TP').doc(currentTPId).update({
                    membres: firebase.firestore.FieldValue.arrayRemove(userId)
                });
                showUserNotification('Membre retir√©', 'success');
                await loadCurrentMembers();
            } catch(e) {
                console.error('Erreur retrait membre:', e);
                showUserNotification('Erreur: ' + e.message, 'error');
            }
        }

        // √âcouter la touche Entr√©e pour la recherche
        document.getElementById('searchMembre')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchUsers();
        });

        // ==========================================
        // CHATBOT IA - Elise
        // ==========================================
        let chatHistory = [];
        let isChatOpen = false;

        function toggleChat() {
            const panel = document.getElementById('chatPanel');
            const btn = document.getElementById('chatbotBtn');
            isChatOpen = !isChatOpen;
            if (isChatOpen) {
                panel.style.display = 'flex';
                panel.classList.remove('closing');
                panel.classList.add('active');
                btn.innerHTML = '<i class="fas fa-times"></i>';
                if (document.getElementById('chatMessages').children.length === 0) {
                    showWelcomeMessage();
                }
                setTimeout(() => document.getElementById('chatInput').focus(), 300);
            } else {
                panel.classList.remove('active');
                panel.classList.add('closing');
                btn.innerHTML = '<i class="fas fa-robot"></i>';
                setTimeout(() => {
                    panel.classList.remove('closing');
                    panel.style.display = 'none';
                }, 300);
            }
        }

        function showWelcomeMessage() {
            const messagesDiv = document.getElementById('chatMessages');
            const time = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

            messagesDiv.innerHTML = `
                <div class="chat-msg-bot">
                    <strong>Bonjour ! Je suis Elise</strong> ü§ñ<br><br>
                    Votre experte en Ingenierie mecanique et industrielle. Je suis la pour vous aider avec :
                    <ul>
                        <li>L'utilisation des machines de l'atelier</li>
                        <li>Les consignes de securite</li>
                        <li>La maintenance et l'entretien</li>
                        <li>Le stockage et le rangement</li>
                    </ul>
                    Comment puis-je vous aider ?
                    <div class="chat-time">${time}</div>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; padding: 4px 0;">
                    <span class="chat-suggestion" onclick="askSuggestion(this.textContent)">Comment utiliser le tour CNC ?</span>
                    <span class="chat-suggestion" onclick="askSuggestion(this.textContent)">Quels EPI sont obligatoires ?</span>
                    <span class="chat-suggestion" onclick="askSuggestion(this.textContent)">Procedure d'urgence</span>
                    <span class="chat-suggestion" onclick="askSuggestion(this.textContent)">Maintenance preventive</span>
                </div>
            `;
        }

        function askSuggestion(text) {
            document.getElementById('chatInput').value = text;
            sendChatMessage();
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            const messagesDiv = document.getElementById('chatMessages');
            const time = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

            // Ajouter le message utilisateur
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-msg-user';
            userMsg.innerHTML = `${escapeHtml(message)}<div class="chat-time" style="color:rgba(255,255,255,0.7);">${time}</div>`;
            messagesDiv.appendChild(userMsg);

            // Supprimer les suggestions
            messagesDiv.querySelectorAll('.chat-suggestion').forEach(el => el.parentElement?.remove());

            // Indicateur de frappe
            const typing = document.createElement('div');
            typing.className = 'chat-typing';
            typing.innerHTML = '<span></span><span></span><span></span>';
            messagesDiv.appendChild(typing);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            try {
                const response = await callAI(message);
                typing.remove();

                const botMsg = document.createElement('div');
                botMsg.className = 'chat-msg-bot';
                botMsg.innerHTML = `${formatBotResponse(response)}<div class="chat-time">${time}</div>`;
                messagesDiv.appendChild(botMsg);

                // Ajouter au historique (format OpenAI)
                chatHistory.push({ role: 'user', content: message });
                chatHistory.push({ role: 'assistant', content: response });
            } catch (error) {
                typing.remove();
                const errMsg = document.createElement('div');
                errMsg.className = 'chat-msg-bot';
                if (error.message === 'CLE_NON_CONFIGUREE') {
                    errMsg.innerHTML = `<span style="color:#ef4444;"><strong>Elise n'est pas encore configuree</strong><br>L'administrateur doit configurer la cle API depuis le panneau admin.</span><div class="chat-time">${time}</div>`;
                } else {
                    errMsg.innerHTML = `<span style="color:#ef4444;">Erreur : ${escapeHtml(error.message)}</span><div class="chat-time">${time}</div>`;
                }
                messagesDiv.appendChild(errMsg);
                console.error('Erreur chatbot:', error);
            }

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        let cachedApiKey = '';

        async function getApiKey() {
            if (cachedApiKey) return cachedApiKey;
            const local = localStorage.getItem('esig_ai_api_key');
            if (local) { cachedApiKey = local; return local; }
            try {
                const doc = await db.collection('settings').doc('ai_config').get();
                if (doc.exists && doc.data().apiKey) {
                    cachedApiKey = doc.data().apiKey;
                    localStorage.setItem('esig_ai_api_key', cachedApiKey);
                    return cachedApiKey;
                }
            } catch(e) { console.error('Erreur lecture cle API:', e); }
            return window.AI_CONFIG?.apiKey || '';
        }

        async function callAI(message) {
            const config = window.AI_CONFIG;
            const apiKey = await getApiKey();
            if (!config || !apiKey) {
                throw new Error('CLE_NON_CONFIGUREE');
            }

            const messages = [
                { role: 'system', content: config.systemPrompt },
                ...chatHistory,
                { role: 'user', content: message }
            ];

            const response = await fetch(config.apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: config.model,
                    messages: messages,
                    temperature: 0.7,
                    max_tokens: 1024
                })
            });

            if (!response.ok) {
                const errData = await response.json().catch(() => ({}));
                throw new Error(errData.error?.message || `Erreur API: ${response.status}`);
            }

            const data = await response.json();
            const text = data.choices?.[0]?.message?.content;
            if (!text) throw new Error('Reponse vide de l\'API');
            return text;
        }

        function formatBotResponse(text) {
            // Convertir le markdown basique en HTML
            let html = escapeHtml(text);
            // Gras **text**
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Italique *text*
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            // Listes √† puces
            html = html.replace(/^[-‚Ä¢]\s+(.+)/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
            // Listes num√©rot√©es
            html = html.replace(/^\d+\.\s+(.+)/gm, '<li>$1</li>');
            // Retours √† la ligne
            html = html.replace(/\n/g, '<br>');
            // Nettoyer les <br> avant/apr√®s les listes
            html = html.replace(/<br><ul>/g, '<ul>');
            html = html.replace(/<\/ul><br>/g, '</ul>');
            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function clearChat() {
            chatHistory = [];
            showWelcomeMessage();
        }
    </script>
</body>

</html>