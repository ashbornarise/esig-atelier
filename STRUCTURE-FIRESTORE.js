/**
 * STRUCTURE FIRESTORE - ESIG ATELIER 2.0
 * 
 * Ce fichier documente exactement comment structurer vos collections Firestore
 * Copiez-collez les exemples dans Firestore Console pour créer les premières données
 */

// ================================================================
// COLLECTION: users
// ================================================================
// Description: Utilisateurs enregistrés
// Documente: {uid} = ID utilisateur Firebase
// Permissions: Admin + propriétaire

{
  "uid": "autoGeneratedByFirebase",
  "email": "admin@esig.tg",
  "prenom": "Admin",
  "nom": "ESIG",
  "role": "admin",  // Valeurs: admin, etudiant, enseignant, technicien
  "niveau": "Master",  // L1, L2, L3, M1, M2, Autre
  "groupe": "Administration",
  "dateCreation": "2025-01-18T10:00:00Z",
  "actif": true,
  "phone": "+228 XX XX XX XX",
  "adresse": "Lome, Togo",
  "photoURL": null
}

// ================================================================
// COLLECTION: tp
// ================================================================
// Description: Travaux pratiques enregistrés par les utilisateurs
// Document ID: Auto-généré par Firestore
// Permissions: Tous (lecture), créateur + admin (modif/delete)

{
  "id": "autoGeneratedByFirebase",
  "titre": "Usinage - Pièce cylindrique",
  "type": "usinage",  // Valeurs: usinage, tournage, fraisage, soudure, montage, cao, automatisme, autre
  "dateDebut": "2025-01-20T10:00:00Z",
  "duree": 2.5,  // En heures
  "createdBy": "uid123",  // UID de l'utilisateur qui a créé
  "dateCreation": "2025-01-18T10:00:00Z",
  "statut": "planifie",  // Valeurs: planifie, en_cours, termine, annule
  "description": "Fabrication d'une pièce cylindrique sur tour CNC avec respect des tolérances",
  "membres": ["uid123", "uid456"],  // UIDs des participants
  "machinesUtilisees": [
    {
      "machineId": "machine123",
      "duree": 2  // Heures
    }
  ],
  "remarques": "Attention à la vitesse de rotation"
}

// ================================================================
// COLLECTION: machines
// ================================================================
// Description: Machines et équipements de l'atelier
// Document ID: Auto-généré par Firestore
// Permissions: Tous (lecture), admin (modif/delete)

{
  "id": "autoGeneratedByFirebase",
  "nom": "Tour parallèle CNC-01",
  "type": "Tournage",  // Ex: Tournage, Fraisage, Soudure, CAO, etc.
  "modele": "HAAS ST-20Y",
  "statut": "disponible",  // Valeurs: disponible, occupee, maintenance
  "lieu": "Salle d'usinage A",  // Localisation dans l'atelier
  "dateAcquisition": "2023-06-15T00:00:00Z",
  "nombreHeuresUtilisation": 1250,
  "dateProchaineMaintenance": "2025-02-15T00:00:00Z",
  "responsable": "uid789",  // UID du technicien responsable
  "dateCreation": "2025-01-18T10:00:00Z",
  "notes": "Révision complète en janvier 2025. Machine en bon état"
}

// ================================================================
// COLLECTION: stocks
// ================================================================
// Description: Inventaire des matériaux et consommables
// Document ID: Auto-généré par Firestore
// Permissions: Tous (lecture), admin (modif/delete)

{
  "id": "autoGeneratedByFirebase",
  "nom": "Acier inoxydable 304 - Feuille 1mm",
  "categorie": "materiaux",  // Valeurs: outils, materiaux, consommables, epi, pieces
  "quantite": 150,
  "quantiteMinimale": 50,  // Alerte quand quantite <= quantiteMinimale
  "unite": "kg",  // kg, m, piece, litre, etc.
  "prix": 8.50,  // Prix unitaire
  "fournisseur": "ArcelorMittal",
  "dateAjout": "2025-01-18T10:00:00Z",
  "dateExpiration": "2026-01-18T00:00:00Z",  // Si applicable
  "emplacement": "Étagère C-12",  // Localisation physique
  "notes": "Stock commandé en janvier 2025. Bon pour 2 ans"
}

// ================================================================
// COLLECTION: maintenance
// ================================================================
// Description: Tâches de maintenance des machines
// Document ID: Auto-généré par Firestore
// Permissions: Tous (lecture), admin (modif/delete)

{
  "id": "autoGeneratedByFirebase",
  "machineId": "machine123",  // Référence à une machine
  "type": "quotidienne",  // Valeurs: quotidienne, hebdo, mensuelle, trimestrielle, annuelle, corrective
  "description": "Changement de l'huile et vérification du système de refroidissement",
  "datePrevu": "2025-01-25T10:00:00Z",
  "dateRealisation": null,  // null si pas encore fait, timestamp si terminé
  "dateCreation": "2025-01-18T10:00:00Z",
  "responsable": "uid789",  // UID du technicien
  "statut": "planifie",  // Valeurs: planifie, en_cours, termine
  "heures": 2,  // Heures estimées/réelles
  "notes": "À faire pendant la pause de midi. Fermer la machine avant."
}

// ================================================================
// COLLECTION: logs (OPTIONNEL - Audit trail)
// ================================================================
// Description: Journal des actions pour audit
// Document ID: Auto-généré par Firestore
// Permissions: Admin (lecture/creation), user (création propres logs)

{
  "id": "autoGeneratedByFirebase",
  "userId": "uid123",
  "action": "CREATE",  // CREATE, READ, UPDATE, DELETE
  "collection": "tp",  // Quelle collection a été affectée
  "documentId": "tp456",
  "timestamp": "2025-01-18T10:05:00Z",
  "details": {
    "titre": "Usinage - Pièce cylindrique",
    "duree": 2.5
  }
}

// ================================================================
// EXEMPLES D'INITIALISATION
// ================================================================

// EXEMPLE 1: Créer une machine via le code
// (À faire dans la console du navigateur après authentification admin)

await DataManager.machines.create({
    nom: "Tour CNC-01",
    type: "Tournage",
    modele: "HAAS ST-20Y",
    statut: "disponible",
    lieu: "Salle A",
    dateAcquisition: new Date("2023-06-15"),
    nombreHeuresUtilisation: 1250,
    notes: "Machine en excellent état"
});

// EXEMPLE 2: Créer un stock
await DataManager.stocks.create({
    nom: "Acier 5mm",
    categorie: "materiaux",
    quantite: 100,
    quantiteMinimale: 20,
    unite: "kg",
    prix: 8.50,
    fournisseur: "ArcelorMittal",
    emplacement: "Étagère A-5"
});

// EXEMPLE 3: Ajouter une tâche de maintenance
await DataManager.maintenance.create({
    machineId: "machine123",
    type: "preventive",
    description: "Vérification des courroies",
    datePrevu: new Date("2025-01-25"),
    heures: 2,
    notes: "À faire mardi matin"
});

// ================================================================
// IMPORTER DES DONNÉES (Bulk)
// ================================================================

// Si vous avez des données en CSV ou JSON, voici comment les importer:

async function importerDonnees(donnees) {
    for (const item of donnees) {
        await db.collection('machines').add(item);
        console.log('✅ Machine importée:', item.nom);
    }
}

// Utilisation:
const machinesAImporter = [
    { nom: "Tour 1", type: "Tournage", statut: "disponible", lieu: "A" },
    { nom: "Tour 2", type: "Tournage", statut: "disponible", lieu: "B" },
    { nom: "Fraiseuse 1", type: "Fraisage", statut: "disponible", lieu: "C" }
];

importerDonnees(machinesAImporter);

// ================================================================
// INDEX & OPTIMISATION
// ================================================================

// Firestore vous proposera automatiquement de créer des index
// quand vous faites des requêtes complexes. Acceptez-les !

// Index recommandés:
// - collection: tp, champs: createdBy, dateDebut (DESC)
// - collection: machines, champs: statut
// - collection: stocks, champs: quantite (ASC)
// - collection: maintenance, champs: datePrevu (ASC)

// ================================================================
// REQUÊTES COURANTES
// ================================================================

// Tous mes TP (utilisateur courant)
db.collection('tp')
    .where('createdBy', '==', uid)
    .orderBy('dateDebut', 'desc')
    .get()

// Machines disponibles
db.collection('machines')
    .where('statut', '==', 'disponible')
    .get()

// Stock bas (< quantité minimale)
db.collection('stocks')
    .where('quantite', '<=', firestore.FieldValue.documentId())
    .get()

// Maintenance à venir (7 prochains jours)
db.collection('maintenance')
    .where('datePrevu', '>=', new Date())
    .where('datePrevu', '<=', new Date(Date.now() + 7*24*60*60*1000))
    .orderBy('datePrevu', 'asc')
    .get()

// ================================================================
// SAUVEGARDER LES DONNÉES
// ================================================================

// Firebase inclut automatique des sauvegardes !
// Mais vous pouvez exporter manuellement:

async function exporterDonnees() {
    const tp = await db.collection('tp').get();
    const machines = await db.collection('machines').get();
    const stocks = await db.collection('stocks').get();
    
    const donnees = {
        tp: tp.docs.map(d => d.data()),
        machines: machines.docs.map(d => d.data()),
        stocks: stocks.docs.map(d => d.data())
    };
    
    console.log(JSON.stringify(donnees, null, 2));
    // Sauvegardez ce JSON en fichier !
}

// ================================================================
// NOTES IMPORTANTES
// ================================================================

// 1. UIDs sont auto-générés par Firebase Auth
//    Ne les changez pas ! Ils sont immutables

// 2. Timestamps: Utilisez new Date() ou firestore.Timestamp.now()
//    Firebase convertit automatiquement

// 3. Montant des données: Firebase compte en lectures/écritures
//    Optimisez vos requêtes pour limiter les coûts

// 4. Suppression en cascade: Si vous supprimez une machine,
//    les références dans "maintenance" ne sont pas auto-supprimées
//    À gérer manuellement dans votre code

// 5. Limites Firestore:
//    - 20K documents par requête
//    - 1MB max par document
//    - 500 écritures simultanées max

// ================================================================
